---
title: "EpisodesFile Creator"
author: "Göran Broström"
date: "June 16, 2016"
output: html_document
bibliography: ids.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(haven)
```

# Introduction

This is an attempt to directly translate the Stata program *EpisodesFileCreator* [@lq15; @lq16] to an **R** *function*, which I will call *efc*. I will strictly follow the same sectioning as Luciana. For illustration, this process will utilize two example input files, *VarSetup.dta* and *Chronicle.dta*, created by another of Luciana Quaranta's Stata program from an *IDS* data base from *CEDAR*, Umeå University. 

## The arguments of *efc*

The function *afc* takes three arguments: *VarSetup* and *Chronicle* give the names of the input files, while *atrisk* is the name of the variable that represent being at risk. We start here by giving these values, which will be part of the function call in the final product.

```{r}
varsetup <- "data/VarSetup.dta"
chronicle <- "data/Chronicle.dta"
atrisk <-  "At_risk"
```


# PART 1: Read and prepare the variable setup


```{r varsetup}
if (file.exists(varsetup)){
    VarSetup <- read_dta(varsetup)
}else{
    stop(paste(varsetup, "not found. Find and restart!"))
}
necessary <- c("Type", "Duration", "Transition")
miss <- !(necessary %in% names(VarSetup))
if (sum(miss)){
    stop(paste("Missing in VarSetup:", necessary[miss], "(restart required)"))
}else{
    cat("The VarSetup is OK.\n")
}
```


Our *VarSetup* file looks like this (six first lines), for the record:

```{r headvarsetup}
head(VarSetup)
```

## Replacing a value of the *Type* variable (for some reason?)

```{r replaceatriskvarsetup}
VarSetup1 <- VarSetup # Why? we'll see later?
VarSetup1$Type[VarSetup1$Type == atrisk] <- "AtRisk"
```
Do we need *VarSetup* later? We'll see.

## Transition

```{r transition}
TypeTransition <- VarSetup1[, c("Type", "Transition")]
```

## Duration

```{r duration}
TypeDuration <- VarSetup1[with(VarSetup1, Duration == "Continuous" & Transition != "End"), "Type"]
```

## Minus1 (?)

```{r minus1}
TypeReplaceMin1 <- TypeDuration
```

The need for this copy will probably show later.

## Labels

Seems completely unnecessary. We skip it until proven wrong.

# PART 2: Read and prepare the *Chronicle*

```{r readchronicle}
if (file.exists(chronicle)){
    Chronicle <- read_dta(chronicle)
}else{
    stop(paste(chronicle), "does not exist. Stop and find!\n")
}
```


## Check correct variable names

```{r checkchronnames}
varnames <- names(Chronicle)
if ("ID_I" %in% varnames){
    pos <- which(varnames == "ID_I")
    varnames[pos] <- "Id_I" # "Real" replacement later, in "ExtractionFile"
}
obligat <- c("Id_I", "Day", "Month", "Year", "DayFrac", "Type", "Value")
whoerr <- !(varnames %in% obligat)
if (sum(whoerr)){
    stop(paste("Missing variable names in Chronicle:", varnames[whoerr], ": FIX IT!"))
}else{
    cat("Names in Chronicle OK.\n")
}
```

## Replacing name of atrisk variable and replace ID_I by Id_I (if necessary)

Note: This section comes *after* the next one in Luciana's *EpisodesFileCreator*. I think that was an error. Note also that we *never* change *Chronicle* (a stata necessity, remove later?). Changes go into *ExtractionFile*.

```{r replaceatriskchron}
ExtractionFile <- Chronicle
names(ExtractionFile) <- varnames
repl <- ExtractionFile$Type == atrisk
if (sum(repl)){
    ExtractionFile$Type[repl] <- "AtRisk"
}else{
    stop("No 'at risk' variable found in the chronicle file. FIX and restart!")
}
```

## Generate DateFormat for Types without Value

Seems rather complicated in the *stata code*:

```{statacode}
    use Chronicle.dta, clear
    merge m:1 Type using TypeTransition.dta, nogen norep
    capture gen emptyType=(Value=="")
    keep if Transition!="End" & Type!="AtRisk"
    collapse (max) maxempty=emptyType (min) minempty=emptyType, by(Type)
    capture keep if maxempty==1 & minempty==1
    capture keep Type
    capture duplicates drop
    capture gen DateFormat="YMD"
    save TypeDateFormat.dta, replace
```

I try to translate that like this:

```{r gendateformat}
TypeDateFormat <- data.frame(Type = unique(Chronicle$Type[Chronicle$Value == ""]),
                             DateFormat = "YMD")
```

Comment?


# Created

```{r createdate}
format(Sys.time(), "%b_%d_%Y_%H:%M:%S")
```


# References
